# 阶段 1.2 行动指南：核心类结构与基础配置管理

在这一阶段，我们将正式编写 SDK 的核心骨架代码。我们要创建一个 `Tracker` 类（相当于 SDK 的大脑），实现用户调用 `register` 初始化配置以及 `addCommonParams` 添加通用参数的功能。

请按照以下步骤一步步操作：

## 步骤 1：规划目录结构并创建核心文件

为了让代码更易维护，我们将在 `packages/sdk/src` 目录下按功能拆分文件：

1. 打开终端（或在 VSCode 资源管理器中操作），确保当前在 `packages/sdk` 目录下。
2. 在 `src` 目录下创建两个新的子文件夹：`types` 和 `core`。
3. 在 `src/types` 下新建文件 `index.ts`。
4. 在 `src/core` 下新建文件 `Tracker.ts`。

你的 `src` 目录结构应该变成这样：
```text
src/
├── core/
│   └── Tracker.ts    # 核心类文件
├── types/
│   └── index.ts      # 所有类型声明文件
└── index.ts          # 统一导出入口
```

## 步骤 2：定义核心数据类型 (`src/types/index.ts`)

为了充分利用 TypeScript 的优势，我们要先定义好“初始化需要传什么配置”以及“通用参数长什么样”。

打开 `packages/sdk/src/types/index.ts`，复制并粘贴以下内容：

```typescript
/**
 * SDK 初始化配置项
 */
export interface InitOptions {
  /**
   * 项目唯一标识
   */
  project_id: string;
  /**
   * 服务端数据接收接口的 URL
   */
  requestUrl: string;
  /**
   * 数据上报的采样率 (0 ~ 1，默认为 1，即 100% 上报)
   */
  upload_percent?: number;
  /**
   * 合并上报队列的最大等待时间 (毫秒)，默认 3000ms
   */
  batchWaitTime?: number;
  /**
   * 同时缓存的最大上报数量，默认 5 条
   */
  batchMaxLength?: number;
}

/**
 * 埋点数据的通用参数类型
 */
export interface CommonParams {
  [key: string]: any;
}
```

## 步骤 3：编写大脑：`Tracker` 类 (`src/core/Tracker.ts`)

这是我们 SDK 的灵魂。我们要实现一个单例（确保全局只有一个 Tracker 实例），并把用户的配置和通用参数存起来。

打开 `packages/sdk/src/core/Tracker.ts`，复制并粘贴以下代码：

```typescript
import { InitOptions, CommonParams } from '../types';

export class Tracker {
  /**
   * 保存初始化配置
   */
  private options: InitOptions;
  
  /**
   * 保存通过 addCommonParams 动态添加的通用参数
   */
  private commonParams: CommonParams;

  constructor() {
    // 默认配置
    this.options = {
      project_id: '',
      requestUrl: '',
      upload_percent: 1,
      batchWaitTime: 3000,
      batchMaxLength: 5,
    };
    this.commonParams = {};
  }

  /**
   * 页面初始化：注册埋点基础信息
   * @param options 初始化配置项
   */
  public register(options: InitOptions): void {
    // 合并用户配置与默认配置
    this.options = { ...this.options, ...options };
    console.log('[TrackPoint] SDK 初始化成功', this.options);
  }

  /**
   * 添加通用参数：允许在任意时刻添加埋点上报时默认带上的参数
   * @param params 键值对对象
   */
  public addCommonParams(params: CommonParams): void {
    // 合并新的参数到已有的通用参数中
    this.commonParams = { ...this.commonParams, ...params };
    console.log('[TrackPoint] 通用参数已更新', this.commonParams);
  }

  // ==== 供内部或测试使用的获取方法（非必选，仅为验证） ====
  public getOptions() {
    return this.options;
  }
  public getCommonParams() {
    return this.commonParams;
  }
}

// 导出一个单例实例供全局使用
export const tracker = new Tracker();
```

## 步骤 4：暴露对外的 API (`src/index.ts`)

业务方最终是通过 `import { register } from '@byte/track-point'` 来使用我们的 SDK 的。所以我们需要在入口文件把这些方法暴露出去。

修改原有的 `packages/sdk/src/index.ts`，将其内容替换为：

```typescript
import { tracker } from './core/Tracker';
import { InitOptions, CommonParams } from './types';

/**
 * 暴露对外的初始化方法
 */
export const register = (options: InitOptions) => {
  tracker.register(options);
};

/**
 * 暴露对外的添加通用参数方法
 */
export const addCommonParams = (params: CommonParams) => {
  tracker.addCommonParams(params);
};

// 暴露版本号
export const VERSION = '1.0.0';

// 也可以把所有类型导出去，方便业务方使用 TS
export * from './types';
```

## 步骤 5：验证与验收！

代码写完了，我们怎么知道它是对的呢？在根目录跑一个小测试。

1. 在 `packages/sdk` 目录下新建一个文件叫 `test.ts` (随便在哪都行，就在 sdk 根目录吧)。
2. 把下面的测试代码丢进去：

```typescript
// packages/sdk/test.ts
import { register, addCommonParams, VERSION } from './src/index';
import { tracker } from './src/core/Tracker';

console.log('--- 开始测试 SDK ---');
console.log('当前 SDK 版本:', VERSION);

// 1. 测试初始化
register({
  project_id: 'my-test-project',
  requestUrl: 'https://api.my-domain.com/track',
  upload_percent: 0.5
});

// 2. 测试添加通用参数
addCommonParams({ env: 'production', userId: '88888' });
addCommonParams({ theme: 'dark' }); // 再次添加，应该合并

console.log('\n--- 最终状态检查 ---');
console.log('最终 Options:', tracker.getOptions());
console.log('最终 CommonParams:', tracker.getCommonParams());
```

3. 为了能直接运行 TS 文件，我们需要一个工具。在终端执行：
   ```bash
  npx tsx test.ts
   ```

**验收标准：**
如果终端输出了类似下面的结果，说明阶段 1.2 圆满完成！

```text
--- 开始测试 SDK ---
当前 SDK 版本: 1.0.0
[TrackPoint] SDK 初始化成功 {
  project_id: 'my-test-project',
  requestUrl: 'https://api.my-domain.com/track',
  upload_percent: 0.5,
  batchWaitTime: 3000,
  batchMaxLength: 5
}
[TrackPoint] 通用参数已更新 { env: 'production', userId: '88888' }
[TrackPoint] 通用参数已更新 { env: 'production', userId: '88888', theme: 'dark' }

--- 最终状态检查 ---
最终 Options: {
  project_id: 'my-test-project',
  requestUrl: 'https://api.my-domain.com/track',
  upload_percent: 0.5,
  batchWaitTime: 3000,
  batchMaxLength: 5
}
最终 CommonParams: { env: 'production', userId: '88888', theme: 'dark' }
```

**请按照上述步骤进行操作，如果你在执行 `npx ts-node test.ts` 时看到了预期的输出结果，请随时告诉我，我们就进入下一个“自动采集环境信息”的爽快阶段！**