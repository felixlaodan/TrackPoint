# 阶段一：埋点 SDK 开发（@byte/track-point）详细规划

本阶段的核心目标是**完成数据采集端的开发**。SDK 产出的数据结构将直接决定后续 Server 端的数据库设计。为了在短时间内高效、稳定地完成开发，我们将第一大阶段拆分为以下 7 个微小阶段（小步快跑，每个阶段都有明确的产出和验收标准）。

---

## 1.1 初始化工程与打包配置 (Vite Library Mode)

**目标**：搭建一个极简、开箱即用的 TypeScript SDK 库开发环境。
**需要做什么**：
1. 在 `packages/sdk` 目录下初始化 `package.json`。
2. 安装 Vite 和 TypeScript 相关依赖 (`vite`, `typescript`, `vite-plugin-dts` 用于生成 `.d.ts` 声明文件)。
3. 配置 `vite.config.ts`，开启 Library 模式，配置入口文件为 `src/index.ts`，配置打包输出格式（UMD 和 ES）。
4. 配置 `tsconfig.json`。

**呈现结果**：一个配置完善的 SDK 基础目录结构。
**验收标准**：
- 运行 `npm run build`，能在 `dist` 目录下成功产出 `.js` (打包后代码) 和 `.d.ts` (类型声明文件)，且没有报错。

---

## 1.2 核心类结构与基础配置管理

**目标**：构建 SDK 的主骨架 `Tracker` 类，实现基础配置项的管理。
**需要做什么**：
1. 定义核心类型声明（如：配置项接口 `InitOptions`，事件上报接口 `TrackEvent`）。
2. 实现 `Tracker` 单例类。
3. 实现 `register(options)` 方法：接收并保存项目 ID (`project_id`)、服务端接口地址 (`requestUrl`)、合并上报等待时间等配置。
4. 实现 `addCommonParams(params)` 方法：支持在任意时刻动态添加全局通用的业务参数。

**呈现结果**：`src/core/Tracker.ts` 核心文件。
**验收标准**：
- 能通过实例调用 `register` 初始化配置，并能通过内部方法正确读取这些配置。
- 调用 `addCommonParams` 后，后续生成的事件数据中能自动合并这些通用参数。

---

## 1.3 用户环境信息自动采集

**目标**：实现 SDK 初始化时自动获取终端用户的环境上下文信息。
**需要做什么**：
1. 编写环境获取工具函数 `src/utils/env.ts`。
2. 采集静态信息：浏览器类型及版本、操作系统类型及版本、屏幕分辨率 (`screen.width`/`height`)。
3. 采集动态信息：当前页面 URL (`location.href`)、页面来源 (`document.referrer`)。
4. 生成/获取用户唯一标识 `uid` (如果没有业务传入，则尝试从 cookie/localStorage 读取或自动生成一个 UUID 存入本地)。
5. 将这些环境信息在 `Tracker` 初始化时合并到全局上下文中。

**呈现结果**：完善的环境信息获取工具包。
**验收标准**：
- 控制台打印环境信息获取函数的返回值，能准确识别当前测试浏览器的基本信息和设备信息。

---

## 1.4 核心上报机制与缓存队列调度

**目标**：实现稳定、高性能的事件上报（包含进阶功能：合并上报）。
**需要做什么**：
1. 实现基础 `sendEvent(eventName, params)` 组装逻辑：将事件名、当前时间戳、全局通用参数、环境信息、本次特殊参数合并为一个完整的数据对象。
2. 实现**缓存队列机制**：不立即发送请求，而是将数据对象 `push` 进一个数组队列中。
3. 实现**触发发送调度策略**：
   - 达到最大缓存数量（如：5条）时立即触发发送。
   - 达到设定的等待时间（如：3000ms）时触发发送（使用定时器防抖/节流）。
   - 监听页面卸载事件 (`beforeunload` / `pagehide`)，在用户关闭页面前强制清空队列上报。
4. 封装底层的发送请求函数：优先使用 `navigator.sendBeacon` (无阻塞上报)，降级使用 `fetch` / `XMLHttpRequest`。

**呈现结果**：具备队列管理和降级发送能力的完整上报链路代码。
**验收标准**：
- 连续调用 3 次 `sendEvent`，观察 Network 面板，确认请求没有立即发出；等待 N 秒后，看到一次合并了 3 条数据的完整网络请求。
- 关闭页面时，能成功触发最后一次缓存队列的上报（在 Network 面板开启 Preserve log 查看）。

---

## 1.5 全局错误自动捕获 (异常监控)

**目标**：实现代码运行时的自动异常上报。
**需要做什么**：
1. 监听 `window.addEventListener('error', callback, true)`，捕获 JS 运行时错误和静态资源（图片/JS）加载错误。
2. 监听 `window.addEventListener('unhandledrejection', callback)`，捕获 Promise 未处理的异常。
3. 将捕获到的错误信息（报错信息、报错文件路径、行号列号）提取格式化后，自动调用内部的 `sendEvent` 上报一个特殊的错误事件（如：`EventName.SYSTEM_ERROR`）。

**呈现结果**：`src/plugins/error.ts` 错误监听模块。
**验收标准**：
- 在测试页面中手动抛出一个错误 (`throw new Error('test')`) 或写一个不存在的图片路径，观察是否自动触发了含有详细错误堆栈的埋点上报请求。

---

## 1.6 白屏监控 (进阶功能)

**目标**：实现页面极端加载失败（白屏）的监控报警。
**需要做什么**：
1. 实现一个轮询检测或利用 `MutationObserver` 监听根节点（如 `#root` 或 `#app`）的 DOM 变化。
2. 设定一个超时阈值（如 3000ms），如果页面关键元素仍未渲染完整，则判定为白屏。
3. 判定白屏后，调用内部 `sendEvent` 自动上报白屏事件。

**呈现结果**：`src/plugins/blank.ts` 白屏检测模块。
**验收标准**：
- 模拟一个空的 HTML 页面（不挂载任何 React/Vue 节点），等待 3 秒后，观察是否触发了白屏埋点上报。

---

## 1.7 本地构建与 Demo 验收

**目标**：确保最终构建的 SDK 可独立运行，并在本地完成沙盒验证。
**需要做什么**：
1. 在 `packages/sdk` 目录下新建一个 `index.html`，用于引入打包后的 SDK 产物。
2. 编写测试脚本：调用初始化、设置参数、手动触发事件、模拟报错。
3. 编写 `npm run serve` 或使用 vite 原生能力启动一个本地静态服务器来预览该 `index.html`。
4. 审查 `dist/` 目录产物的体积和代码混淆情况。

**呈现结果**：一个可直观验证 SDK 所有功能的本地测试 Demo。
**验收标准**：
- 在本地跑起 Demo 后，通过浏览器的 Network 和 Console 面板，能够完整、准确地看到初始化、普通事件合并上报、错误上报的整个闭环过程（此时 Server 尚未开发，只要请求 Payload 数据结构正确即算完成）。